/*! This is open-source. Feel free to use, modify, redistribute, and so on.
 */
function addDependency(e,t,n){var i,o
if(e.isKindOfActor()?i=e.id:e.isKindOfInnerElement()&&(i=e.attributes.parent),n.isKindOfActor()?o=n.id:n.isKindOfInnerElement()&&(o=n.attributes.parent),e===n)console.log("INVALID: you cannot create a dependency from an element to itself."),alert("INVALID: you cannot create a dependency from an element to itself.")
else if(e.isLink()||n.isLink())console.log("INVALID: you cannot create a dependency from/to another link."),alert("INVALID: you cannot create a dependency from/to another link.")
else if(e.isDependum()||n.isDependum())console.log("INVALID: you cannot create a dependency from/to a dependum."),alert("INVALID: you cannot create a dependency from/to a dependum.")
else if(i===o)console.log("INVALID: you cannot create a dependency with a single actor."),alert("INVALID: you cannot create a dependency with a single actor.")
else if(i&&o){var r="",l="Dependum"
r="QualityDependencyLink"===t?istar.addQuality(10,10,l):"TaskDependencyLink"===t?istar.addTask(10,10,l):"ResourceDependencyLink"===t?istar.addResource(10,10,l):istar.addGoal(10,10,l),links=istar.addDependencyLink(e,r,n),istar.rotateLabel(links[0]),istar.rotateLabel(links[1]),links[0].on("change:vertices",ui._toggleSmoothness),links[1].on("change:vertices",ui._toggleSmoothness),links[0].on("remove",function(){this.getSourceElement()&&this.getSourceElement().isDependum()&&(this.getSourceElement().remove({disconnectLinks:!0}),this.prop("otherHalf").remove()),this.getTargetElement()&&this.getTargetElement().isDependum()&&(this.getTargetElement().remove({disconnectLinks:!0}),this.prop("otherHalf").remove())}),links[1].on("remove",function(){this.getSourceElement()&&this.getSourceElement().isDependum()&&(this.getSourceElement().remove({disconnectLinks:!0}),this.prop("otherHalf").remove()),this.getTargetElement()&&this.getTargetElement().isDependum()&&(this.getTargetElement().remove({disconnectLinks:!0}),this.prop("otherHalf").remove())}),ui.selectElement(r)}}function addElementInPlace(e,t,n,i){ui.currentState=ui.STATE_VIEW,ui.resetAddingElement()
var o
if(e.isKindOfActor())o=t(n,i),e.embedNode(o)
else{var r=istar.graph.getCell(e.attributes.parent)
r&&r.isKindOfActor()&&(o=t(n,i),istar.graph.getCell(e.attributes.parent).embedNode(o))}return o}function createDownloadLink(e,t,n,i){var o=document.createElement("a")
o.download=e,o.title=i,o.href=n
var r=document.createTextNode(t)
return o.appendChild(r),o}function addPngLink(e){var t=createDownloadLink("goalModel.png","PNG",e,"download PNG")
$("#saveImage").append(t)}function createButtons(){return hoverButtons=[],this}function changeCustomPropertyValue(e,t,n){return n=n?$.trim(n):"",e.prop("customProperties/"+t,n),e}var ui=function(){return{STATE_ADD_ACTOR:"addActor",STATE_ADD_LINK:"addLink",STATE_ADD_NODE:"addNode",STATE_VIEW:"view",currentButton:null,currentState:"view",currentAddingElement:"none",linkSource:"none",linkTarget:"none",dependencyType:"GoalDependencyLink",selectedElement:null,currentStateIsAddKindOfActor:function(){return this.currentState===this.STATE_ADD_ACTOR},currentStateIsAddLink:function(){return this.currentState===this.STATE_ADD_LINK},currentStateIsAddNode:function(){return this.currentState===this.STATE_ADD_NODE},currentStateIsView:function(){return this.currentState===this.STATE_VIEW},isCurrentlyAddingElement:function(){return"none"!==this.currentAddingElement},isLinkSourceUndefined:function(){return"none"===this.linkSource},isLinkTargetUndefined:function(){return"none"===this.linkTarget},resetAddingElement:function(){return this.currentAddingElement="none",this},resetLinkSource:function(){return this.linkSource="none",this},resetLinkTarget:function(){return this.linkTarget="none",this},getSelectedElement:function(){return this.selectedElement},selectElement:function(e,t){if(e){var n=!1
this.selectedElement&&this.selectedElement!=e&&this.clearSelection(),this.selectedElement!=e&&(n=!0),this.selectedElement=e,n&&(t=t||istar.paper.findViewByModel(e),istar.paper.trigger("change:selection",{selectedElement:e,selectedElementView:t}))}},deselectElement:function(e,t){if(e){var t=t||istar.paper.findViewByModel(e)
this.selectedElement=null,istar.paper.trigger("change:selection",{deselectedElement:e,deselectedElementView:t})}},clearSelection:function(){if(this.selectedElement){var e=istar.paper.findViewByModel(this.selectedElement)
this.deselectElement(this.selectedElement,e)}},hideSelection:function(){this.selectedElement&&this.unhighlightFocus(istar.paper.findViewByModel(this.selectedElement))},showSelection:function(){this.selectedElement&&this.highlightFocus(istar.paper.findViewByModel(this.selectedElement))}}}()
ui.highlighter={name:"stroke",options:{padding:7,rx:-5,ry:-5,attrs:{"stroke-width":2,stroke:"#555555"}}},ui.highlightFocus=function(e){e&&e.highlight(null,{highlighter:ui.highlighter})},ui.unhighlightFocus=function(e){e&&e.unhighlight(null,{highlighter:ui.highlighter})},ui.defineInteractions=function(){istar.paper.on("change:selection",function(e){e.selectedElement?(ui.table=new uiC.PropertiesTableView({model:e.selectedElement}).render(),e.selectedElementView&&ui.highlightFocus(e.selectedElementView)):e.deselectedElement&&(ui.unhighlightFocus(e.deselectedElementView),ui.table.remove(),$("#propertyTable").find("tbody").html(""),$("#cellButtons").html(""))}),istar.paper.on("blank:pointerdown",function(e,t,n){ui.getSelectedElement()&&ui.clearSelection(),ui.currentStateIsAddKindOfActor()&&ui.addElementOnPaper(t,n)}),istar.paper.on("cell:mouseover",function(e,t,n,i){color="rgb(63,72,204)",e.model.isKindOfActor()?e.model.prop("collapsed")?(e.$("circle").css({stroke:color,"stroke-width":"2"}),e.$(".actorDecorator").css({stroke:color,"stroke-width":"2"})):(e.$("rect").css({stroke:color,"stroke-width":"4"}),e.$("circle").css({stroke:"black","stroke-width":"3"})):e.model.get("parent")&&(parentView=istar.paper.findViewByModel(istar.graph.getCell(e.model.get("parent"))),parentView.$("rect").css({stroke:color,"stroke-width":"4"}),parentView.$("circle").css({stroke:"black","stroke-width":"3"}))}),istar.paper.on("cell:mouseout",function(e,t,n,i){e.model.isKindOfActor()?(e.$("rect").css({stroke:"black","stroke-width":"2"}),e.$("circle").css({stroke:"black","stroke-width":"2"}),e.$(".actorDecorator").css({stroke:"black","stroke-width":"2"})):e.model.get("parent")&&(parentView=istar.paper.findViewByModel(istar.graph.getCell(e.model.get("parent"))),parentView.$("rect").css({stroke:"black","stroke-width":"2"}),parentView.$("circle").css({stroke:"black","stroke-width":"2"}))}),istar.paper.on("cell:pointerup",function(e,t,n,i){if(t.ctrlKey&&e.model.isKindOfActor()&&(ui.hideSelection(),e.model.toggleCollapse(),ui.showSelection()),ui.currentStateIsAddNode())ui.addElementOnActor(e,n-50,i-18)
else if(ui.currentStateIsAddLink()){if(e.model.isKindOfActor())ui.currentAddingElement.match(/IsALink|ParticipatesInLink/)?ui.isLinkSourceUndefined()?(e.highlight(),ui.linkSource=e):ui.addLinkBetweenActors(ui.currentAddingElement,e):ui.dependencyType.match(/DependencyLink/)&&(ui.isLinkSourceUndefined()?(e.highlight(),ui.linkSource=e):(ui.linkTarget=e,addDependency(ui.linkSource.model,ui.dependencyType,ui.linkTarget.model),ui.linkSource.unhighlight(),ui.currentButton.end()))
else if(ui.currentAddingElement.match(/AndRefinementLink|OrRefinementLink|NeededByLink|QualificationLink|ContributionLink|DependencyLink|make|help|hurt|break/))if(ui.isLinkSourceUndefined())e.highlight({blur:10,color:"blue"}),ui.linkSource=e
else{if(ui.linkTarget=e,ui.currentAddingElement.match(/AndRefinementLink|OrRefinementLink|NeededByLink|QualificationLink|ContributionLink|make|help|hurt|break/)){if("AndRefinementLink"===ui.currentAddingElement)istar.addAndRefinementLink(ui.linkSource.model,ui.linkTarget.model)
else if("OrRefinementLink"===ui.currentAddingElement)istar.addOrRefinementLink(ui.linkSource.model,ui.linkTarget.model)
else if("NeededByLink"===ui.currentAddingElement)istar.addNeededByLink(ui.linkSource.model,ui.linkTarget.model)
else if("QualificationLink"===ui.currentAddingElement)istar.addQualificationLink(ui.linkSource.model,ui.linkTarget.model)
else if(ui.currentAddingElement.match(/make|help|hurt|break/i)){var o=istar.addContributionLink(ui.linkSource.model,ui.linkTarget.model,ui.currentAddingElement)
o&&o.on("change:vertices",ui._toggleSmoothness)}}else ui.dependencyType.match(/DependencyLink/)&&addDependency(ui.linkSource.model,ui.dependencyType,ui.linkTarget.model)
ui.linkSource.unhighlight(),ui.currentButton.end()}}else ui.currentStateIsView()&&(e.model.isLink()||ui.selectElement(e.model,e))}),istar.paper.on("cell:pointerdblclick",function(e,t,n,i){var o
e.model.isLink()?e.model.isContributionLink()&&null!==(o=window.prompt("make, help, hurt, or break",e.model.getContributionType()))&&e.model.setContributionType(o):(oldText=e.model.prop("name"),null!==(o=window.prompt("Edit text:",oldText))&&e.model.changeNodeContent(o))}),istar.paper.on("cell:contextmenu",function(e,t,n,i){}),$.fn.editable.defaults.mode="inline"},ui.addElementOnPaper=function(e,t){try{newActor=istar["add"+ui.currentAddingElement](e,t),ui.selectElement(newActor)}catch(e){console.log(e)}finally{ui.currentButton.end()}},ui.addElementOnActor=function(e,t,n){try{element=addElementInPlace(e.model,istar[istar.PREFIX_ADD+ui.currentAddingElement],t,n),ui.selectElement(element)}catch(e){console.log(e)}finally{ui.currentButton.end()}},ui.addLinkBetweenActors=function(e,t){try{ui.linkTarget=t,istar.types[e].isValid(ui.linkSource.model,ui.linkTarget.model)?istar[istar.PREFIX_ADD+ui.currentAddingElement](ui.linkSource.model,ui.linkTarget.model):alert("Sorry, it is not possible to add a '"+e+"' link from a "+ui.linkSource.model.get("type")+" to a "+ui.linkTarget.model.get("type"))}catch(e){console.log(e)}finally{ui.linkSource.unhighlight(),ui.currentButton.end()}},ui.changeColorActorContainer=function(e){_.map(istar.getElements(),function(t){t.isKindOfActor()&&t.attr("rect",{fill:e})})},ui.connectLinksToShape=function(){$("#modals *").css("cursor","wait"),setTimeout(function(){istar.paper.options.linkConnectionPoint=joint.util.shapePerimeterConnectionPoint,_.each(istar.getElements(),function(e){e.translate(1),e.translate(-1)}),istar.paper.options.linkConnectionPoint=void 0,$("#modals *").css("cursor","auto")},100)},$("#saveImageButton").click(function(){var e=$(".marker-vertices, .link-tools, .marker-arrowheads, .remove-element"),t=$("#saveImage")
e.hide(),ui.hideSelection()
var n=saveSvg("diagram")
t.html(createDownloadLink("goalModel.svg","◀ SVG",n,"download SVG (vectorial)")),t.append(document.createTextNode(" - ")),savePng("diagram",addPngLink),t.show(),e.show(),ui.showSelection(ui.getSelectedElement())}),$("#saveModelButton").click(function(){var e=saveModel()
ui.hideSelection(),ui.showSelection(),csvData="data:text/json;charset=utf-8,"+encodeURI(e),a=createDownloadLink("goalModel.txt","◀ File",csvData,"download goal model"),$("#saveModel").html(a).show()}),$("#saveImage, a").click(function(){$("#saveImage").hide(200)}),$("#saveModel, a").click(function(){$("#saveModel").hide(200)}),$("#loadButton").click(function(){$(this).button("loading"),setTimeout(function(){try{var e=$("#actualFileInput")[0]
if(0===e.files.length)alert("You must select a file to load"),$("#loadModelModal").modal("hide"),$("#loadButton").button("reset")
else{var t=e.files[0]
if("text/plain"===t.type){var n=new FileReader
n.onload=function(e){fileManager.load(e.target.result),$("#loadModelModal").modal("hide"),$("#loadButton").button("reset")},n.readAsText(t)}else alert("Sorry, this kind of file is not valid"),$("#loadButton").button("reset"),$("#loadModelModal").modal("hide")}}catch(e){$("#loadButton").button("reset"),alert("Sorry, the input model is not valid."),console.log(e.stack)}},20)}),ui.setupUi=function(){this.defineInteractions(),uiC.createAddButtons(),$("#saveImage").hide(),$("#saveModel").hide(),$("#diagramWidthInput").val(istar.paper.getArea().width),$("#diagramHeightInput").val(istar.paper.getArea().height)},$("#diagramSizeButton").click(function(){istar.paper.setDimensions($("#diagramWidthInput").val(),$("#diagramHeightInput").val())}),$("#whiteActorsButton").click(function(){ui.changeColorActorContainer("white")}),$("#analyseModelButton").click(function(){var e="Number of elements: "+istar.getNumberOfElements(),t="Number of links: "+istar.getNumberOfLinks()
alert(e+"\n"+t+"\n\nOBS: each dependency counts as two links - one from the depender to the dependum, and another from the dependum to the dependee.")}),$("#preciseLinksButton").click(function(){ui.connectLinksToShape()}),$("#clearButton").click(function(){confirm("Are you sure you want to delete every element of this model?")&&ui.clearDiagram()}),ui.clearDiagram=function(){istar.graph.clear()}
var hoverButtons=[]
$("#instructionsTitle").click(function(){$("#instructionsContent").toggle(300)}),$("#instructionsContent").toggle(0),ui.changeStatus=function(e){$("#status").html(e)},$("#examplesArea").on("show.bs.collapse",function(){$("#examplesButton").addClass("active")}),$("#examplesArea").on("hide.bs.collapse",function(){$("#examplesButton").removeClass("active")}),$("#helpArea").on("show.bs.collapse",function(){$("#helpButton").addClass("active")}),$("#helpArea").on("hide.bs.collapse",function(){$("#helpButton").removeClass("active")}),$("#feedbackArea").on("show.bs.collapse",function(){$("#feedbackButton").addClass("active")}),$("#feedbackArea").on("hide.bs.collapse",function(){$("#feedbackButton").removeClass("active")}),$(document).keyup(function(e){null!==ui.getSelectedElement()&&ui.currentStateIsView()&&(46===e.which&&(ui.getSelectedElement().remove(),ui.clearSelection()),27===e.which&&ui.clearSelection()),ui.isCurrentlyAddingElement()&&27===e.which&&ui.currentButton.end()}),ui.changeStateToEdit=function(){ui.currentState="edit",ui.resetPointerStyles()},ui.changeStateToView=function(){ui.currentState="view"},ui.resetPointerStyles=function(){$diagram=$("#diagram"),$diagram.css("cursor","auto"),$diagram.find("g").css("cursor","move"),$diagram.find(".actorKindMain").css("cursor","move"),$(".link-tools g").css("cursor","pointer")},ui._toggleSmoothness=function(e,t,n){t.length>=1?e.set("smooth",!0):0===t.length&&e.set("smooth",!1)}
